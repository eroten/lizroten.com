---
title: Maps with {edgebundle}
author: admin
date: '2020-12-19'
slug: maps-with-edgebundle
categories:
  - blog
  - map
tags:
  - ggplot2
  - tidyverse
  - cartography
  - map
subtitle: 'Mapping US flight networks'
toc: true
summary: ''
authors: []
lastmod: '2020-12-19T13:53:43-06:00'
featured: yes
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---


<div id="TOC">
true
</div>

<div id="goal" class="section level2">
<h2>Goal</h2>
<p>Use <code>{edgebundle}</code> to map flight patterns from BNA and MSP.</p>
<pre class="r"><code># remotes::install_github(&quot;schochastics/edgebundle&quot;)
library(edgebundle)
library(igraph)
library(ggplot2)
library(ggraph)
library(dplyr)
library(sf)
library(tigris)

set.seed(24601)

my_caption &lt;- c(&quot;Liz Roten (@LizRoten) | Data: openflights.org&quot;)</code></pre>
<p>We also need to use the Python library, datashader. <code>{edgebundle}</code> ships with a nice function for installing all the dependencies.</p>
<pre class="r"><code>edgebundle:::install_bundle_py()</code></pre>
</div>
<div id="data-prep" class="section level2">
<h2>Data prep</h2>
<p>The data we will use is <code>us_flights</code>, which is shipped with <code>{edgebundle}</code>. <code>us_flights</code> is a complex object.</p>
<pre class="r"><code>flights &lt;- us_flights # name us_flights
coords &lt;- cbind(V(flights)$longitude, V(flights)$latitude) # extract coordinates

# create vertex sequence
verts &lt;- data.frame(x = V(flights)$longitude, y = V(flights)$latitude) </code></pre>
<div id="supporting-data" class="section level3">
<h3>Supporting data</h3>
<p>To make our output a little more aesthetically pleasing, we will go ahead and transform the data to use Albers Equal Area Conic.</p>
<pre class="r"><code>states &lt;- tigris::states(cb = TRUE, progress_bar = FALSE) %&gt;% 
  filter(STUSPS %in% state.abb,
         !NAME %in% c(&quot;Alaska&quot;,
                      &quot;Hawaii&quot;)) %&gt;% 
  sf::st_transform(crs = &quot; +proj=aea +lat_1=20 +lat_2=60 +lat_0=40 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m no_defs&quot;)</code></pre>
<pre class="r"><code>coords_full &lt;- cbind(V(flights)$longitude, V(flights)$latitude,  V(flights)$name) # extract coordinates


coords_sf &lt;- st_as_sf(x = as.data.frame(coords_full), coords = c(&quot;V1&quot;, &quot;V2&quot;), crs = 4326) %&gt;% 
  sf::st_transform(crs = &quot; +proj=aea +lat_1=20 +lat_2=60 +lat_0=40 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m no_defs&quot;)</code></pre>
</div>
</div>
<div id="edge-bundles" class="section level2">
<h2>Edge bundles</h2>
<p>Create edge bundles</p>
<pre class="r"><code>force_bundle &lt;- edge_bundle_force(flights, xy = coords, compatibility_threshold = 0.6) 

force_bundle_sf &lt;- force_bundle %&gt;% 
  st_as_sf(coords = c(&quot;x&quot;, &quot;y&quot;), crs = 4326) %&gt;% 
  sf::st_transform(crs = &quot; +proj=aea +lat_1=20 +lat_2=60 +lat_0=40 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m no_defs&quot;) %&gt;% 
  rowwise() %&gt;% 
  mutate(x_coord = st_coordinates(geometry)[[1]],
         y_coord = st_coordinates(geometry)[[2]])</code></pre>
<pre class="r"><code>hammer_bundle &lt;- edgebundle::edge_bundle_hammer(object = flights, 
                                                xy = coords, 
                                                bw = 0.7,
                                                decay = 0.5)

hammer_bundle_sf &lt;- hammer_bundle %&gt;% 
  st_as_sf(coords = c(&quot;x&quot;, &quot;y&quot;), crs = 4326) %&gt;% 
  sf::st_transform(crs = &quot; +proj=aea +lat_1=20 +lat_2=60 +lat_0=40 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m no_defs&quot;) %&gt;% 
  rowwise() %&gt;% 
  mutate(x_coord = st_coordinates(geometry)[[1]],
         y_coord = st_coordinates(geometry)[[2]])</code></pre>
</div>
<div id="map" class="section level2">
<h2>Map</h2>
<pre class="r"><code>my_theme &lt;- theme_void() +
  theme(
    plot.background = element_rect(fill = &quot;black&quot;,
                                   linetype = 0,
                                   color = NA),
    panel.background = element_rect(
      fill = &quot;black&quot;,
      linetype = 0,
      color = NA
    ),
    plot.title = element_text(family = &quot;Agency FB&quot;,
                              color = &quot;white&quot;,
                              size = 20),
    plot.caption = element_text(
      family = &quot;LeelawadeeUI-Semilight&quot;,
      color = &quot;white&quot;
    ),
    plot.subtitle = element_text(
      color = &quot;white&quot;
    ),
    plot.margin = unit(c(.5, .5, .2, .5), &quot;cm&quot;),
  )

line_color &lt;- &quot;#e79e4f&quot;</code></pre>
<pre class="r"><code>base_plot &lt;- geom_sf(data = states,
          color = &quot;white&quot;,
          fill = NA,
          lwd = 0.1) </code></pre>
<pre class="r"><code>ggplot() +
  base_plot +
  geom_path(data = force_bundle_sf,
            aes(x = x_coord,
                y = y_coord,
                group = group),
            color = line_color,
            size = 0.5,
            alpha = 0.2) +
  geom_path(data = force_bundle_sf,
            aes(x = x_coord,
                y = y_coord,
                group = group),
            color = &quot;white&quot;,
            size = 0.005,
            alpha = 0.1) +
  geom_sf(data = coords_sf,
          color = line_color,
          size = 0.25) +
    geom_sf(data = coords_sf,
          color = &quot;white&quot;,
          size = 0.25,
          alpha = 0.1) +
  labs(title = &quot;US Flight Network&quot;,
       subtitle = &quot;Force Bundle Method&quot;,
       caption = my_caption) +
  my_theme </code></pre>
<p><img src="/lizroten.com/post/2020-12-19-maps-with-edgebundle/index.en_files/figure-html/force_bundle_method-1.png" width="672" /></p>
<pre class="r"><code>ggplot() +
  base_plot +
    geom_path(data = hammer_bundle_sf,
            aes(x = x_coord,
                y = y_coord,
                group = group),
            color = line_color,
            size = 0.5,
            alpha = 0.2) +
  geom_path(data = hammer_bundle_sf,
            aes(x = x_coord,
                y = y_coord,
                group = group),
            color = &quot;white&quot;,
            size = 0.005,
            alpha = 0.1) +
  geom_sf(data = coords_sf,
          color = line_color,
          size = 0.25) +
    geom_sf(data = coords_sf,
          color = &quot;white&quot;,
          size = 0.25,
          alpha = 0.1) +
  labs(title = &quot;US Flight Network&quot;,
       subtitle = &quot;Hammer Bundle Method&quot;,
       caption = my_caption) +
  my_theme </code></pre>
<p><img src="/lizroten.com/post/2020-12-19-maps-with-edgebundle/index.en_files/figure-html/hammer_bundle_method-1.png" width="672" /></p>
</div>
<div id="finese-hammer-bundle-method" class="section level2">
<h2>Finese hammer bundle method</h2>
<pre class="r"><code>hammer_bundle_adj &lt;- edgebundle::edge_bundle_hammer(object = flights, 
                                                xy = coords, 
                                                bw = 0.2,
                                                decay = 0.5)

hammer_bundle_adj_sf &lt;- hammer_bundle_adj %&gt;% 
  st_as_sf(coords = c(&quot;x&quot;, &quot;y&quot;), crs = 4326) %&gt;% 
  sf::st_transform(crs = &quot; +proj=aea +lat_1=20 +lat_2=60 +lat_0=40 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m no_defs&quot;) %&gt;% 
  rowwise() %&gt;% 
  mutate(x_coord = st_coordinates(geometry)[[1]],
         y_coord = st_coordinates(geometry)[[2]])

ggplot() +
  base_plot +
    geom_path(data = hammer_bundle_adj_sf,
            aes(x = x_coord,
                y = y_coord,
                group = group),
            color = line_color,
            size = 0.5,
            alpha = 0.2) +
  geom_path(data = hammer_bundle_adj_sf,
            aes(x = x_coord,
                y = y_coord,
                group = group),
            color = &quot;white&quot;,
            size = 0.005,
            alpha = 0.1) +
  geom_sf(data = coords_sf,
          color = line_color,
          size = 0.25) +
    geom_sf(data = coords_sf,
          color = &quot;white&quot;,
          size = 0.25,
          alpha = 0.1) +
  labs(title = &quot;US Flight Network&quot;,
       subtitle = &quot;Hammer Bundle Method (adj)&quot;,
       caption = my_caption) +
  my_theme </code></pre>
<p><img src="/lizroten.com/post/2020-12-19-maps-with-edgebundle/index.en_files/figure-html/hammer_bundle_method_adj-1.png" width="672" /></p>
</div>
